name: Common environment setup

runs:
  using: composite
  steps:
    - name: Disable man-db
      shell: bash
      run: |
        echo "set man-db/auto-update false" | sudo debconf-communicate
        sudo dpkg-reconfigure man-db
    - name: Install build dependencies
      shell: bash
      run: |
        # Skip translations to speed up apt-get update
        echo 'Acquire::Languages "none";' | sudo tee /etc/apt/apt.conf.d/99no-translations > /dev/null
        # Makefile expects ARCH-linux-gnu-gcc; install if not available
        case "$(uname -m)" in
          x86_64)  command -v x86_64-linux-gnu-gcc  >/dev/null || { sudo apt-get update && sudo apt-get install -y gcc-x86-64-linux-gnu; } ;;
          aarch64) command -v aarch64-linux-gnu-gcc >/dev/null || { sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu; } ;;
        esac
    - name: Set up Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum
      id: go
    - name: Install protoc
      uses: ./.github/workflows/protoc
